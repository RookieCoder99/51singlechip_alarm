C51 COMPILER V9.54   DS18B20                                                               05/27/2019 15:40:44 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE DS18B20
OBJECT MODULE PLACED IN .\output\ds18b20.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ds18b20.c LARGE OPTIMIZE(8,SIZE) BROWSE DEBUG OBJECTEXTEND PRINT(.\outpu
                    -t\ds18b20.lst) TABS(2) OBJECT(.\output\ds18b20.obj)

line level    source

   1          /*****************************************************************************
   2          * 文件名：DS18B20.c
   3          * 说  明：操作以DS18B20为代表的单总线通信的基本函数
   4          *****************************************************************************/
   5          #include "main.h"
   6          #include "delay.h"
   7          
   8          sbit DQ = P3^7;     // 数据通信线DQ
   9          
  10          
  11          /******************************************************
  12          * 函  数： 初始化DS18B20（产生复位脉冲、等待应答信号）
  13          * 参  数：空
  14          * 返回值：无
  15          ******************************************************/
  16          void master_reset(void)
  17          {
  18   1        uint i = 0;
  19   1      
  20   1        DQ = 1;
  21   1        DQ = 0;
  22   1        delay_us(80); //拉低480~960us,这里大该80*9+10us 
  23   1        //for(i=100; i>0; i--);
  24   1        DQ = 1;     // 产生上升沿
  25   1      
  26   1        i = 20;
  27   1        while(DQ == 1)  //上升沿，等待应答信号（15~60us）
  28   1        {   
  29   2          if(i-- == 0)
  30   2            break;
  31   2        }
  32   1      
  33   1        i = 100;
  34   1        while(DQ == 0)  //应答信号 60~240um
  35   1        {
  36   2          if(i-- == 0)
  37   2            break;
  38   2        }
  39   1        delay_us(5);  //短暂延时
  40   1        DQ = 1; 
  41   1      }
  42          
  43          /******************************************************
  44          * 函  数：读取数据的一个位（满足读时隙要求）
  45          * 参  数：空
  46          * 返回值：读到的数据位
  47          ******************************************************/
  48          bit sing_read_bit(void)
  49          {
  50   1        bit b = 0;
  51   1      
  52   1        DQ = 0;     //把总线拉低，低电平延时大于1us
  53   1        _nop_();
  54   1        DQ = 1;     //释放低电平，等待DS18B20输出数据
C51 COMPILER V9.54   DS18B20                                                               05/27/2019 15:40:44 PAGE 2   

  55   1        delay_us(1);  //延时15us以上，读时隙下降沿后15us，DS18B20输出数据才有效
  56   1        b = DQ;
  57   1        delay_us(5);  //延时大于45us(5*9+8us)
  58   1        return (b);
  59   1      }
  60          
  61          /******************************************************
  62          * 函  数：读取数据的一个字节
  63          * 参  数：空
  64          * 返回值：读到的数据
  65          ******************************************************/
  66          uchar sing_read_byte(void)
  67          {
  68   1        uchar i,j,b;
  69   1        b = 0;
  70   1        for (i=1; i<=8; i++)
  71   1        {
  72   2          j = sing_read_bit();
  73   2          b = (j<<7)|(b>>1);
  74   2        }
  75   1        return(b);
  76   1      }
  77          
  78          /******************************************************
  79          * 函  数：写一个字节数据（注意写0和写1的时序）
  80          * 参  数：b要写的数据
  81          * 返回值：无
  82          ******************************************************/
  83          void sing_write_byte(uchar b)
  84          {
  85   1        uint i;
  86   1        uchar j;
  87   1        bit btmp;
  88   1        for(j=1;j<=8;j++)
  89   1        {
  90   2          btmp = b&0x01;
  91   2          b = b>>1;   // 取下一位（由低位向高位）
  92   2          if (btmp)
  93   2          {
  94   3            /* 写1 */
  95   3            DQ = 0;
  96   3            i++;i++;  // 延时，使得15us以内拉高
  97   3            DQ = 1;
  98   3            i = 8;
  99   3            while(i>0) i--; // 整个写1时隙不低于60us 
 100   3            }
 101   2          else
 102   2          {
 103   3            /* 写0 */
 104   3            DQ = 0;     
 105   3            i = 8;
 106   3            while(i>0) i--; // 保持低在60us到120us之间
 107   3            DQ = 1;
 108   3            i++;
 109   3            i++;
 110   3          }
 111   2        }
 112   1      }
 113          
 114          /******************************************************
 115          * 函  数：启动温度转换
 116          * 参  数：空
C51 COMPILER V9.54   DS18B20                                                               05/27/2019 15:40:44 PAGE 3   

 117          * 返回值：无
 118          ******************************************************/
 119          void temper_convert(void)
 120          {
 121   1        EA = 0;
 122   1        master_reset();       //初始化DS18B20（产生复位脉冲、等待应答信号） 
 123   1        sing_write_byte(0xCC);    // skip rom 命令
 124   1        sing_write_byte(0x44);    // convert T 命令
 125   1        EA = 1;
 126   1      }
 127          
 128          /******************************************************
 129          * 函  数：读取温度值
 130          * 参  数：pbuff[0]保存整数位，pbuff[1]保存小数
 131          * 返回值：无
 132          ******************************************************/
 133          void read_temper(uchar *pbuff)
 134          {
 135   1        uchar tplsb,tpmsb;
 136   1        EA = 0;
 137   1        master_reset();       //初始化DS18B20（产生复位脉冲、等待应答信号） 
 138   1        sing_write_byte(0xCC);    // skip rom 命令
 139   1        sing_write_byte(0xBE);    // read scratchpad 命令
 140   1        tplsb = sing_read_byte(); // 温度值低位字节（其中低4位为二进制的“小数”部分）
 141   1        tpmsb = sing_read_byte(); // 高位值高位字节（其中高5位为符号位）
 142   1        EA = 1;   
 143   1      
 144   1        *pbuff = (tpmsb<<4)|(tplsb>>4);//整数部分高位左移4位，低位右移4位
 145   1        *(pbuff+1) = (tplsb&0x0F);  //小数部分，低位的低四位
 146   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    299    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----       6
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       2
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
